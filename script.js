const HISTORY_LIMIT=50,PRICE_LIST_LIMIT=15,products=JSON.parse(localStorage.getItem("products"))||[];let selectedProduct=null,deleteCallback=null;const productNameInput=document.getElementById("productName"),productPriceInput=document.getElementById("productPrice"),addBtn=document.getElementById("addBtn"),updatePriceInput=document.getElementById("updatePrice"),updateBtn=document.getElementById("updateBtn"),exportBtn=document.getElementById("exportBtn"),importBtn=document.getElementById("importBtn"),fileInput=document.getElementById("fileInput"),pricesList=document.getElementById("pricesList"),pricesTitle=document.getElementById("pricesTitle"),pricesSection=document.getElementById("pricesSection"),confirmDialog=document.getElementById("confirmDialog"),confirmYes=document.getElementById("confirmYes"),confirmNo=document.getElementById("confirmNo"),confirmMessage=document.getElementById("confirmMessage"),toast=document.getElementById("toast"),itemsList=document.getElementById("itemsList");function formatPrice(t){return Math.round(t).toLocaleString("vi-VN")}function addProduct(){const t=productNameInput.value.trim(),e=Number.parseFloat(productPriceInput.value);if(!t||isNaN(e))return void showToast("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin");if(products.some((e=>e.name.toLowerCase()===t.toLowerCase())))return void showToast("Item n√†y ƒë√£ t·ªìn t·∫°i r·ªìi");const i={id:Date.now(),name:t,prices:[{date:(new Date).toISOString(),price:e}]};products.push(i),saveProducts(),productNameInput.value="",productPriceInput.value="",renderItemsList(),showToast("Item ƒë√£ ƒë∆∞·ª£c th√™m")}function updateProduct(){if(!selectedProduct)return void showToast("Vui l√≤ng ch·ªçn item");const t=Number.parseFloat(updatePriceInput.value);if(isNaN(t))return void showToast("Vui l√≤ng nh·∫≠p gi√° h·ª£p l·ªá");const e=products.find((t=>t.id==selectedProduct));e&&(e.prices.push({date:(new Date).toISOString(),price:t}),e.prices.length>50&&(e.prices=e.prices.slice(-50)),saveProducts(),updatePriceInput.value="",renderItemsList(),renderPricesList(),showToast("Gi√° ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t"))}function deleteProduct(t){const e=Number(t),i=products.find((t=>t.id===e));i?(confirmMessage.textContent=`X√≥a "${i.name}"?`,deleteCallback=()=>{const t=products.findIndex((t=>t.id===e));-1!==t?(products.splice(t,1),saveProducts(),selectedProduct===e?(selectedProduct=null,renderItemsList(),renderPricesList()):renderItemsList(),showToast("Item ƒë√£ ƒë∆∞·ª£c x√≥a")):showToast("X√≥a th·∫•t b·∫°i: item kh√¥ng t·ªìn t·∫°i")},confirmDialog.classList.remove("hidden")):showToast("Kh√¥ng t√¨m th·∫•y item ƒë·ªÉ x√≥a")}function copyItemName(t){navigator.clipboard.writeText(t).then((()=>{showToast(`ƒê√£ copy: "${t}"`)})).catch((()=>{showToast("Copy th·∫•t b·∫°i")}))}function renderItemsList(){itemsList.innerHTML="",0!==products.length?products.forEach((t=>{const e=t.prices[t.prices.length-1]?.price||0,i=document.createElement("div");i.className="item-card"+(selectedProduct===t.id?" selected":""),i.innerHTML=`\n      <div class="item-info">\n        <div class="item-name-wrapper">\n          <div class="item-name">${t.name}</div>\n          <button class="item-copy-btn" data-name="${t.name}" title="Copy t√™n item"> üóê </button>\n        </div>\n        <div class="item-price">Gi√° hi·ªán t·∫°i: ${formatPrice(e)}</div>\n      </div>\n      <div class="item-actions">\n        <button class="item-delete-btn" data-id="${t.id}" title="X√≥a item">x</button>\n      </div>\n    `,i.addEventListener("click",(e=>{e.target.classList.contains("item-delete-btn")||e.target.classList.contains("item-copy-btn")||(selectedProduct=t.id,renderItemsList(),renderPricesList())})),i.querySelector(".item-copy-btn").addEventListener("click",(e=>{e.stopPropagation(),copyItemName(t.name)})),i.querySelector(".item-delete-btn").addEventListener("click",(e=>{e.stopPropagation(),deleteProduct(t.id)})),itemsList.appendChild(i)})):itemsList.innerHTML='<div style="color: var(--text-muted); text-align: center; padding: 20px;">Ch∆∞a c√≥ item n√†o</div>'}function saveProducts(){localStorage.setItem("products",JSON.stringify(products))}function exportData(){const t=JSON.stringify(products,null,2),e=new Blob([t],{type:"application/json"}),i=URL.createObjectURL(e),n=document.createElement("a");n.href=i,n.download="price-tracker-data.json",n.click(),showToast("D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c xu·∫•t")}function importData(t){const e=t.target.files[0];if(!e)return;const i=new FileReader;i.onload=t=>{try{const e=JSON.parse(t.target.result);Array.isArray(e)&&(products.length=0,e.forEach((t=>{Array.isArray(t.prices)&&t.prices.length>50&&(t.prices=t.prices.slice(-50)),products.push(t)})),saveProducts(),renderItemsList(),renderPricesList(),showToast("D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c nh·∫≠p"))}catch(t){showToast("Nh·∫≠p d·ªØ li·ªáu th·∫•t b·∫°i")}},i.readAsText(e)}function showToast(t){toast.textContent=t,toast.classList.add("show"),setTimeout((()=>toast.classList.remove("show")),4e3)}function renderPricesList(){if(!selectedProduct)return pricesTitle.textContent="C·∫≠p Nh·∫≠t Gi√°",updatePriceInput.value="",updatePriceInput.disabled=!0,updateBtn.disabled=!0,void(pricesList.innerHTML='<div style="color: var(--text-muted); text-align: center; padding: 20px;">Ch·ªçn m·ªôt item ƒë·ªÉ xem chi ti·∫øt</div>');const t=products.find((t=>t.id==selectedProduct));if(!t)return pricesTitle.textContent="C·∫≠p Nh·∫≠t Gi√°",updatePriceInput.value="",updatePriceInput.disabled=!0,updateBtn.disabled=!0,void(pricesList.innerHTML='<div style="color: var(--text-muted); text-align: center; padding: 20px;">Item kh√¥ng t·ªìn t·∫°i</div>');updatePriceInput.disabled=!1,updateBtn.disabled=!1,pricesTitle.textContent=`C·∫≠p Nh·∫≠t Gi√° - ${t.name}`;const e=[...t.prices].slice(-15).sort(((t,e)=>new Date(e.date)-new Date(t.date)));pricesList.innerHTML="",e.forEach((t=>{const e=document.createElement("div");e.className="price-item",e.innerHTML=`\n      <div class="price-date">${new Date(t.date).toLocaleDateString()}</div>\n      <div class="price-value">${formatPrice(t.price)}</div>\n      <div class="price-item-actions">\n        <button class="price-item-delete" data-date="${t.date}" title="X√≥a gi√°">x</button>\n      </div>\n    `,pricesList.appendChild(e)}))}addBtn.addEventListener("click",addProduct),updateBtn.addEventListener("click",updateProduct),exportBtn.addEventListener("click",exportData),importBtn.addEventListener("click",(()=>fileInput.click())),fileInput.addEventListener("change",importData),confirmYes.addEventListener("click",(()=>{deleteCallback&&deleteCallback(),confirmDialog.classList.add("hidden")})),confirmNo.addEventListener("click",(()=>{confirmDialog.classList.add("hidden")})),pricesList.addEventListener("click",(t=>{const e=t.target.closest(".price-item-delete");if(!e)return;const i=e.getAttribute("data-date");if(!selectedProduct)return void showToast("Vui l√≤ng ch·ªçn item tr∆∞·ªõc");const n=products.find((t=>t.id===Number(selectedProduct)));n?(confirmMessage.textContent=`X√≥a gi√° ${formatPrice((n.prices.find((t=>t.date===i))||{}).price||0)} ‚Äî ${new Date(i).toLocaleDateString()}?`,deleteCallback=()=>{const t=n.prices.findIndex((t=>t.date===i));-1!==t?(n.prices.splice(t,1),saveProducts(),renderPricesList(),showToast("Gi√° ƒë√£ ƒë∆∞·ª£c x√≥a")):showToast("Kh√¥ng t√¨m th·∫•y gi√° ƒë·ªÉ x√≥a")},confirmDialog.classList.remove("hidden")):showToast("Item kh√¥ng t·ªìn t·∫°i")})),renderItemsList(),renderPricesList();