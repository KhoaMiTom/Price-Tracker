const HISTORY_LIMIT=50,PRICE_LIST_LIMIT=15,products=JSON.parse(localStorage.getItem("products"))||[];let selectedProduct=null,deleteCallback=null;const productNameInput=document.getElementById("productName"),productPriceInput=document.getElementById("productPrice"),addBtn=document.getElementById("addBtn"),dropdownTrigger=document.getElementById("dropdownTrigger"),dropdownMenu=document.getElementById("dropdownMenu"),dropdownText=document.getElementById("dropdownText"),updatePriceInput=document.getElementById("updatePrice"),updateBtn=document.getElementById("updateBtn"),exportBtn=document.getElementById("exportBtn"),importBtn=document.getElementById("importBtn"),fileInput=document.getElementById("fileInput"),priceChart=document.getElementById("priceChart"),prevMonthBtn=document.getElementById("prevMonth"),nextMonthBtn=document.getElementById("nextMonth"),monthDisplay=document.getElementById("monthDisplay"),pricesList=document.getElementById("pricesList"),pricesTitle=document.getElementById("pricesTitle"),chartTooltip=document.getElementById("chartTooltip"),confirmDialog=document.getElementById("confirmDialog"),confirmYes=document.getElementById("confirmYes"),confirmNo=document.getElementById("confirmNo"),confirmMessage=document.getElementById("confirmMessage"),toast=document.getElementById("toast");function addProduct(){const t=productNameInput.value.trim(),e=Number.parseFloat(productPriceInput.value);if(!t||isNaN(e))return void showToast("Vui lòng điền đầy đủ thông tin");const n={id:Date.now(),name:t,prices:[{date:(new Date).toISOString(),price:e}]};products.push(n),saveProducts(),productNameInput.value="",productPriceInput.value="",updateProductSelect(),showToast("Item đã được thêm")}function updateProduct(){if(!selectedProduct)return void showToast("Vui lòng chọn item");const t=Number.parseFloat(updatePriceInput.value);if(isNaN(t))return void showToast("Vui lòng nhập giá hợp lệ");const e=products.find((t=>t.id==selectedProduct));e&&(e.prices.push({date:(new Date).toISOString(),price:t}),e.prices.length>50&&(e.prices=e.prices.slice(-50)),saveProducts(),updatePriceInput.value="",renderChart(),renderPricesList(),showToast("Giá đã được cập nhật"))}function deleteProduct(t){const e=Number(t),n=products.find((t=>t.id===e));n?(confirmMessage.textContent=`Xóa "${n.name}"?`,deleteCallback=()=>{const t=products.findIndex((t=>t.id===e));-1!==t?(products.splice(t,1),saveProducts(),updateProductSelect(),selectedProduct===e&&(selectedProduct=null,dropdownText.textContent="Chọn item",dropdownMenu.querySelectorAll(".dropdown-item").forEach((t=>{t.classList.remove("selected")})),renderChart(),renderPricesList()),showToast("Item đã được xóa")):showToast("Xóa thất bại: item không tồn tại")},confirmDialog.classList.remove("hidden")):showToast("Không tìm thấy item để xóa")}function updateProductSelect(){dropdownMenu.innerHTML='<div class="dropdown-item" data-value=""><span class="dropdown-item-name">Chọn item</span></div>',products.forEach((t=>{const e=document.createElement("div");e.className="dropdown-item",e.setAttribute("data-value",t.id),e.innerHTML=`\n      <span class="dropdown-item-name">${t.name}</span>\n      <button class="dropdown-item-delete" title="Xóa item">×</button>\n    `,dropdownMenu.appendChild(e)}))}function renderChart(){if(!selectedProduct||0===products.length)return priceChart.style.display="none",monthDisplay.textContent="Chưa chọn item",pricesTitle.textContent="50 giá gần nhất",void(pricesList.innerHTML="");priceChart.style.display="block";const t=products.find((t=>t.id==selectedProduct));monthDisplay.textContent="50 giá gần nhất";const e=t.prices.slice(-50),n=priceChart,o=n.getContext("2d"),i=n.getBoundingClientRect();n.width=i.width,n.height=i.height;const r=40,d=n.width-80,c=n.height-80;o.fillStyle="var(--darker)",o.fillRect(0,0,n.width,n.height),o.strokeStyle="#1a2847",o.lineWidth=1;for(let t=0;t<=5;t++){const e=r+c/5*t;o.beginPath(),o.moveTo(r,e),o.lineTo(n.width-r,e),o.stroke()}if(0===e.length)return o.fillStyle="#8a8a8a",o.font="12px Courier New",o.textAlign="center",void o.fillText("Không có dữ liệu cho tháng này",n.width/2,n.height/2);const s=e.map((t=>t.price)),a=Math.min(...s),l=Math.max(...s),p=l-a||1;o.strokeStyle="#FF6B35",o.lineWidth=2,o.beginPath(),e.forEach(((t,i)=>{const s=r+d/(e.length-1||1)*i,l=n.height-r-(t.price-a)/p*c;0===i?o.moveTo(s,l):o.lineTo(s,l)})),o.stroke();const u=[];o.fillStyle="#00D9FF",e.forEach(((t,i)=>{const s=r+d/(e.length-1||1)*i,l=n.height-r-(t.price-a)/p*c;o.beginPath(),o.arc(s,l,4,0,2*Math.PI),o.fill(),u.push({x:s,y:l,price:t.price,date:t.date,index:i})})),o.fillStyle="#8a8a8a",o.font="11px Courier New",o.textAlign="center",o.fillText(`${Math.round(a)}`,10,n.height-r+5),o.fillText(`${Math.round(l)}`,10,45),n.addEventListener("mousemove",(t=>{const e=n.getBoundingClientRect(),o=t.clientX-e.left,i=t.clientY-e.top;let r=null,d=1/0;u.forEach((t=>{const e=Math.sqrt((o-t.x)**2+(i-t.y)**2);e<d&&e<15&&(d=e,r=t)})),r?(chartTooltip.innerHTML=`\n        <div class="tooltip-price">${Math.round(r.price)}</div>\n        <div class="tooltip-date">${new Date(r.date).toLocaleDateString()}</div>\n      `,chartTooltip.style.left=t.clientX+10+"px",chartTooltip.style.top=t.clientY-10+"px",chartTooltip.classList.add("show")):chartTooltip.classList.remove("show")})),n.addEventListener("mouseleave",(()=>{chartTooltip.classList.remove("show")})),renderPricesList()}function saveProducts(){localStorage.setItem("products",JSON.stringify(products))}function exportData(){const t=JSON.stringify(products,null,2),e=new Blob([t],{type:"application/json"}),n=URL.createObjectURL(e),o=document.createElement("a");o.href=n,o.download="price-tracker-data.json",o.click(),showToast("Dữ liệu đã được xuất")}function importData(t){const e=t.target.files[0];if(!e)return;const n=new FileReader;n.onload=t=>{try{const e=JSON.parse(t.target.result);Array.isArray(e)&&(products.length=0,e.forEach((t=>{Array.isArray(t.prices)&&t.prices.length>50&&(t.prices=t.prices.slice(-50)),products.push(t)})),saveProducts(),updateProductSelect(),renderChart(),showToast("Dữ liệu đã được nhập"))}catch(t){showToast("Nhập dữ liệu thất bại")}},n.readAsText(e)}function showToast(t){toast.textContent=t,toast.classList.add("show"),setTimeout((()=>toast.classList.remove("show")),4e3)}function renderPricesList(){if(!selectedProduct)return pricesTitle.textContent="50 giá gần nhất",void(pricesList.innerHTML="");const t=products.find((t=>t.id==selectedProduct));if(!t)return pricesTitle.textContent="50 giá gần nhất",void(pricesList.innerHTML="");pricesTitle.textContent=`15 giá gần nhất của ${t.name}`;const e=[...t.prices].slice(-15).sort(((t,e)=>new Date(e.date)-new Date(t.date)));pricesList.innerHTML="",e.forEach((t=>{const e=document.createElement("div");e.className="price-item",e.innerHTML=`\n      <div class="price-date">${new Date(t.date).toLocaleDateString()}</div>\n      <div class="price-value">${Math.round(t.price)}</div>\n      <div class="price-item-actions">\n        <button class="price-item-delete" data-date="${t.date}" title="Xóa giá">×</button>\n      </div>\n    `,pricesList.appendChild(e)}))}addBtn.addEventListener("click",addProduct),updateBtn.addEventListener("click",updateProduct),exportBtn.addEventListener("click",exportData),importBtn.addEventListener("click",(()=>fileInput.click())),fileInput.addEventListener("change",importData),dropdownTrigger.addEventListener("click",(()=>{dropdownMenu.classList.toggle("show"),dropdownTrigger.classList.toggle("active")})),document.addEventListener("click",(t=>{dropdownTrigger.contains(t.target)||dropdownMenu.contains(t.target)||(dropdownMenu.classList.remove("show"),dropdownTrigger.classList.remove("active"))})),dropdownMenu.addEventListener("click",(t=>{if(t.target.classList.contains("dropdown-item-delete")){t.stopPropagation();const e=t.target.closest(".dropdown-item").getAttribute("data-value");e&&deleteProduct(e)}else if(t.target.classList.contains("dropdown-item")||t.target.classList.contains("dropdown-item-name")){const e=t.target.classList.contains("dropdown-item")?t.target:t.target.closest(".dropdown-item"),n=e.getAttribute("data-value"),o=e.querySelector(".dropdown-item-name"),i=o?o.textContent:e.textContent;n?(selectedProduct=Number(n),dropdownText.textContent=i):(selectedProduct=null,dropdownText.textContent="Chọn item"),dropdownMenu.querySelectorAll(".dropdown-item").forEach((t=>{t.classList.remove("selected")})),n&&e.classList.add("selected"),dropdownMenu.classList.remove("show"),dropdownTrigger.classList.remove("active"),renderChart()}})),confirmYes.addEventListener("click",(()=>{deleteCallback&&deleteCallback(),confirmDialog.classList.add("hidden")})),confirmNo.addEventListener("click",(()=>{confirmDialog.classList.add("hidden")})),updateProductSelect(),renderChart(),pricesList.addEventListener("click",(t=>{const e=t.target.closest(".price-item-delete");if(!e)return;const n=e.getAttribute("data-date");if(!selectedProduct)return void showToast("Vui lòng chọn item trước");const o=products.find((t=>t.id===Number(selectedProduct)));o?(confirmMessage.textContent=`Xóa giá ${Math.round((o.prices.find((t=>t.date===n))||{}).price||0)} — ${new Date(n).toLocaleDateString()}?`,deleteCallback=()=>{const t=o.prices.findIndex((t=>t.date===n));-1!==t?(o.prices.splice(t,1),saveProducts(),renderChart(),renderPricesList(),showToast("Giá đã được xóa")):showToast("Không tìm thấy giá để xóa")},confirmDialog.classList.remove("hidden")):showToast("Item không tồn tại")}));