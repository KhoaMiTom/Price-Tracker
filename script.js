const HISTORY_LIMIT=50,PRICE_LIST_LIMIT=15,products=JSON.parse(localStorage.getItem("products"))||[];let selectedProduct=null,deleteCallback=null;const productNameInput=document.getElementById("productName"),productPriceInput=document.getElementById("productPrice"),addBtn=document.getElementById("addBtn"),updatePriceInput=document.getElementById("updatePrice"),updateBtn=document.getElementById("updateBtn"),exportBtn=document.getElementById("exportBtn"),importBtn=document.getElementById("importBtn"),fileInput=document.getElementById("fileInput"),pricesList=document.getElementById("pricesList"),pricesTitle=document.getElementById("pricesTitle"),pricesSection=document.getElementById("pricesSection"),confirmDialog=document.getElementById("confirmDialog"),confirmYes=document.getElementById("confirmYes"),confirmNo=document.getElementById("confirmNo"),confirmMessage=document.getElementById("confirmMessage"),toast=document.getElementById("toast"),itemsList=document.getElementById("itemsList");function formatPrice(e){return Math.round(e).toLocaleString("vi-VN")}function addProduct(){const e=productNameInput.value.trim(),t=Number.parseFloat(productPriceInput.value);if(!e||isNaN(t))return void showToast("Vui lòng điền đầy đủ thông tin");if(products.some((t=>t.name.toLowerCase()===e.toLowerCase())))return void showToast("Item này đã tồn tại rồi");const i={id:Date.now(),name:e,prices:[{date:(new Date).toISOString(),price:t}]};products.push(i),saveProducts(),productNameInput.value="",productPriceInput.value="",renderItemsList(),showToast("Item đã được thêm")}function updateProduct(){if(!selectedProduct)return void showToast("Vui lòng chọn item");const e=Number.parseFloat(updatePriceInput.value);if(isNaN(e))return void showToast("Vui lòng nhập giá hợp lệ");const t=products.find((e=>e.id==selectedProduct));t&&(t.prices.push({date:(new Date).toISOString(),price:e}),t.prices.length>50&&(t.prices=t.prices.slice(-50)),saveProducts(),updatePriceInput.value="",renderItemsList(),renderPricesList(),showToast("Giá đã được cập nhật"))}function deleteProduct(e){const t=Number(e),i=products.find((e=>e.id===t));i?(confirmMessage.textContent=`Xóa "${i.name}"?`,deleteCallback=()=>{const e=products.findIndex((e=>e.id===t));-1!==e?(products.splice(e,1),saveProducts(),selectedProduct===t?(selectedProduct=null,renderItemsList(),renderPricesList()):renderItemsList(),showToast("Item đã được xóa")):showToast("Xóa thất bại: item không tồn tại")},confirmDialog.classList.remove("hidden")):showToast("Không tìm thấy item để xóa")}function renderItemsList(){itemsList.innerHTML="",0!==products.length?products.forEach((e=>{const t=e.prices[e.prices.length-1]?.price||0,i=document.createElement("div");i.className="item-card"+(selectedProduct===e.id?" selected":""),i.innerHTML=`\n      <div class="item-info">\n        <div class="item-name">${e.name}</div>\n        <div class="item-price">Giá hiện tại: ${formatPrice(t)}</div>\n      </div>\n      <div class="item-actions">\n        <button class="item-delete-btn" data-id="${e.id}" title="Xóa item">x</button>\n      </div>\n    `,i.addEventListener("click",(t=>{t.target.classList.contains("item-delete-btn")||(selectedProduct=e.id,renderItemsList(),renderPricesList())})),i.querySelector(".item-delete-btn").addEventListener("click",(t=>{t.stopPropagation(),deleteProduct(e.id)})),itemsList.appendChild(i)})):itemsList.innerHTML='<div style="color: var(--text-muted); text-align: center; padding: 20px;">Chưa có item nào</div>'}function saveProducts(){localStorage.setItem("products",JSON.stringify(products))}function exportData(){const e=JSON.stringify(products,null,2),t=new Blob([e],{type:"application/json"}),i=URL.createObjectURL(t),n=document.createElement("a");n.href=i,n.download="price-tracker-data.json",n.click(),showToast("Dữ liệu đã được xuất")}function importData(e){const t=e.target.files[0];if(!t)return;const i=new FileReader;i.onload=e=>{try{const t=JSON.parse(e.target.result);Array.isArray(t)&&(products.length=0,t.forEach((e=>{Array.isArray(e.prices)&&e.prices.length>50&&(e.prices=e.prices.slice(-50)),products.push(e)})),saveProducts(),renderItemsList(),renderPricesList(),showToast("Dữ liệu đã được nhập"))}catch(e){showToast("Nhập dữ liệu thất bại")}},i.readAsText(t)}function showToast(e){toast.textContent=e,toast.classList.add("show"),setTimeout((()=>toast.classList.remove("show")),4e3)}function renderPricesList(){if(!selectedProduct)return pricesTitle.textContent="Cập Nhật Giá",updatePriceInput.value="",updatePriceInput.disabled=!0,updateBtn.disabled=!0,void(pricesList.innerHTML='<div style="color: var(--text-muted); text-align: center; padding: 20px;">Chọn một item để xem chi tiết</div>');const e=products.find((e=>e.id==selectedProduct));if(!e)return pricesTitle.textContent="Cập Nhật Giá",updatePriceInput.value="",updatePriceInput.disabled=!0,updateBtn.disabled=!0,void(pricesList.innerHTML='<div style="color: var(--text-muted); text-align: center; padding: 20px;">Item không tồn tại</div>');updatePriceInput.disabled=!1,updateBtn.disabled=!1,pricesTitle.textContent=`Cập Nhật Giá - ${e.name}`;const t=[...e.prices].slice(-15).sort(((e,t)=>new Date(t.date)-new Date(e.date)));pricesList.innerHTML="",t.forEach((e=>{const t=document.createElement("div");t.className="price-item",t.innerHTML=`\n      <div class="price-date">${new Date(e.date).toLocaleDateString()}</div>\n      <div class="price-value">${formatPrice(e.price)}</div>\n      <div class="price-item-actions">\n        <button class="price-item-delete" data-date="${e.date}" title="Xóa giá">x</button>\n      </div>\n    `,pricesList.appendChild(t)}))}addBtn.addEventListener("click",addProduct),updateBtn.addEventListener("click",updateProduct),exportBtn.addEventListener("click",exportData),importBtn.addEventListener("click",(()=>fileInput.click())),fileInput.addEventListener("change",importData),confirmYes.addEventListener("click",(()=>{deleteCallback&&deleteCallback(),confirmDialog.classList.add("hidden")})),confirmNo.addEventListener("click",(()=>{confirmDialog.classList.add("hidden")})),pricesList.addEventListener("click",(e=>{const t=e.target.closest(".price-item-delete");if(!t)return;const i=t.getAttribute("data-date");if(!selectedProduct)return void showToast("Vui lòng chọn item trước");const n=products.find((e=>e.id===Number(selectedProduct)));n?(confirmMessage.textContent=`Xóa giá ${formatPrice((n.prices.find((e=>e.date===i))||{}).price||0)} — ${new Date(i).toLocaleDateString()}?`,deleteCallback=()=>{const e=n.prices.findIndex((e=>e.date===i));-1!==e?(n.prices.splice(e,1),saveProducts(),renderPricesList(),showToast("Giá đã được xóa")):showToast("Không tìm thấy giá để xóa")},confirmDialog.classList.remove("hidden")):showToast("Item không tồn tại")})),renderItemsList(),renderPricesList();